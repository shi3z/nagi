<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Nagi</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css">
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #1a1a2e;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100%;
            height: 100dvh;
        }

        #terminal-container {
            flex: 1;
            overflow: hidden;
            padding: 4px;
        }

        #terminal {
            height: 100%;
        }

        .control-panel {
            background: #16213e;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            border-top: 1px solid #0f3460;
        }

        .control-main {
            display: flex;
            gap: 8px;
        }

        .control-left {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .enter-btn {
            min-width: 70px !important;
            font-size: 16px !important;
            padding: 20px 16px !important;
            align-self: stretch;
        }

        .arrow-pad {
            display: grid;
            grid-template-columns: repeat(3, 44px);
            grid-template-rows: repeat(2, 44px);
            gap: 2px;
        }

        .arrow-pad .btn:nth-child(1) { grid-column: 2; grid-row: 1; }
        .arrow-pad .btn:nth-child(2) { grid-column: 1; grid-row: 2; }
        .arrow-pad .btn:nth-child(3) { grid-column: 2; grid-row: 2; }
        .arrow-pad .btn:nth-child(4) { grid-column: 3; grid-row: 2; }

        .arrow-section {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .page-keys {
            display: flex;
            gap: 2px;
            justify-content: center;
        }

        .page-keys .btn {
            padding: 8px 12px;
            font-size: 12px;
            min-width: 44px;
        }

        .keys-area {
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .other-keys {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .button-row {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            background: #0f3460;
            color: #e94560;
            border: 1px solid #e94560;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            min-width: 50px;
            text-align: center;
            transition: all 0.15s ease;
            user-select: none;
            -webkit-user-select: none;
        }

        .btn:active, .btn.active {
            background: #e94560;
            color: #16213e;
        }

        .btn.wide {
            min-width: 80px;
        }

        .btn.arrow {
            min-width: 44px;
            padding: 12px;
            font-size: 18px;
        }

        .section-label {
            color: #888;
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 2px;
            text-align: center;
        }

        .extra-panel {
            display: none;
            background: #0a0a1a;
            padding: 8px;
            border-radius: 8px;
            margin-top: 4px;
        }

        .extra-panel.visible {
            display: block;
        }

        .tmux-panel {
            display: none;
            background: #0a0a1a;
            padding: 8px;
            border-radius: 8px;
            margin-top: 4px;
        }

        .tmux-panel.visible {
            display: block;
        }

        /* Text Input Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            border: 1px solid #e94560;
        }

        .modal h3 {
            color: #e94560;
            margin: 0 0 15px 0;
            font-size: 16px;
        }

        .modal textarea {
            width: 100%;
            height: 120px;
            background: #1a1a2e;
            color: #fff;
            border: 1px solid #0f3460;
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            resize: none;
            font-family: inherit;
        }

        .modal textarea:focus {
            outline: none;
            border-color: #e94560;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }

        .modal-btn.cancel {
            background: #333;
            color: #fff;
        }

        .modal-btn.send {
            background: #e94560;
            color: #fff;
        }

        .ctrl-keyboard {
            max-width: 400px;
        }

        .ctrl-keyboard h3 {
            text-align: center;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-bottom: 4px;
        }

        .kbd-btn {
            background: #0f3460;
            color: #e94560;
            border: 1px solid #e94560;
            border-radius: 6px;
            padding: 12px 14px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            min-width: 36px;
            text-align: center;
            transition: all 0.15s ease;
        }

        .kbd-btn:active {
            background: #e94560;
            color: #16213e;
        }

        .kbd-btn.wide {
            padding: 12px 24px;
            min-width: 100px;
        }

        /* QWERTY Keyboard Panel */
        .qwerty-panel {
            display: none;
            background: #0a0a1a;
            padding: 8px;
            border-radius: 8px;
            margin-top: 4px;
        }

        .qwerty-panel.visible {
            display: block;
        }

        .custom-panel {
            display: none;
            background: #0a0a1a;
            padding: 8px;
            border-radius: 8px;
            margin-top: 4px;
        }

        .custom-panel:not(:empty) {
            display: block;
        }

        .custom-panel .button-row {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-bottom: 4px;
        }

        .qwerty-row {
            display: flex;
            justify-content: center;
            gap: 3px;
            margin-bottom: 3px;
        }

        .qwerty-btn {
            background: #0f3460;
            color: #e94560;
            border: 1px solid #e94560;
            border-radius: 4px;
            padding: 10px 0;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            min-width: 32px;
            text-align: center;
            transition: all 0.15s ease;
        }

        .qwerty-btn:active {
            background: #e94560;
            color: #16213e;
        }

        .qwerty-btn.space {
            min-width: 150px;
        }

        .qwerty-btn.medium {
            min-width: 50px;
            font-size: 12px;
        }

        .quick-cmd {
            background: #1a1a2e;
            font-size: 12px;
            padding: 8px 12px;
        }

        .status-bar {
            background: #0f3460;
            padding: 4px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e94560;
        }

        .status-dot.connected {
            background: #4caf50;
        }

        #debug {
            display: none;
            background: #000;
            color: #0f0;
            padding: 4px;
            font-size: 10px;
            max-height: 60px;
            overflow: auto;
        }

        /* iPhone compact mode */
        @media (max-width: 480px) {
            .iphone-hide {
                display: none !important;
            }

            .arrow-pad {
                grid-template-columns: repeat(3, 38px);
                grid-template-rows: repeat(2, 38px);
            }

            .btn.arrow {
                min-width: 38px;
                padding: 10px;
                font-size: 16px;
            }

            .enter-btn {
                min-width: 60px !important;
                padding: 15px 12px !important;
            }

            .btn {
                padding: 10px 12px;
                font-size: 13px;
                min-width: 44px;
            }

            .control-panel {
                padding: 6px;
            }

            .iphone-essential {
                display: flex !important;
                gap: 4px;
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (min-width: 481px) {
            .iphone-only {
                display: none !important;
            }
        }

        /* File Browser Styles */
        .filer-toggle-btn {
            position: fixed;
            top: 8px;
            right: 8px;
            background: #0f3460;
            color: #e94560;
            border: 1px solid #e94560;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            z-index: 499;
            font-size: 12px;
            font-weight: bold;
        }

        .filer-toggle-btn:hover, .filer-toggle-btn:active {
            background: #e94560;
            color: #16213e;
        }

        .filer-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: #16213e;
            border-left: 1px solid #e94560;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 500;
            display: flex;
            flex-direction: column;
        }

        .filer-panel.visible {
            transform: translateX(0);
        }

        .filer-header {
            padding: 12px;
            background: #0f3460;
            border-bottom: 1px solid #e94560;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filer-header h3 {
            margin: 0;
            color: #e94560;
            font-size: 14px;
            flex: 1;
        }

        .filer-header .btn {
            padding: 6px 10px;
            min-width: auto;
        }

        .filer-path {
            padding: 8px 12px;
            background: #1a1a2e;
            font-size: 11px;
            color: #888;
            word-break: break-all;
            border-bottom: 1px solid #0f3460;
        }

        .filer-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0;
        }

        .filer-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            cursor: pointer;
            gap: 10px;
            transition: background 0.15s;
            border-bottom: 1px solid #0f3460;
        }

        .filer-item:hover {
            background: #0f3460;
        }

        .filer-item.directory {
            color: #4fc3f7;
        }

        .filer-item.file {
            color: #eee;
        }

        .filer-item .icon {
            font-size: 16px;
            width: 24px;
            text-align: center;
        }

        .filer-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
        }

        .filer-item .size {
            font-size: 11px;
            color: #888;
        }

        .filer-footer {
            padding: 8px 12px;
            border-top: 1px solid #0f3460;
            background: #0a0a1a;
        }

        .filer-footer label {
            font-size: 11px;
            color: #888;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        /* File Viewer Modal */
        .file-viewer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1001;
            flex-direction: column;
        }

        .file-viewer-overlay.visible {
            display: flex;
        }

        .file-viewer-header {
            padding: 8px 16px;
            background: #16213e;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #e94560;
        }

        .file-viewer-header .filename {
            flex: 1;
            color: #e94560;
            font-weight: bold;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-viewer-header .btn {
            padding: 6px 12px;
            min-width: auto;
        }

        .file-viewer-content {
            flex: 1;
            overflow: auto;
            padding: 0;
            background: #1a1a2e;
        }

        .file-viewer-content pre {
            margin: 0;
            padding: 16px;
            font-family: Menlo, Monaco, "Courier New", monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #eee;
        }

        .file-viewer-content code {
            background: transparent !important;
            font-family: Menlo, Monaco, "Courier New", monospace;
            color: #eee;
        }

        /* Image Viewer Modal */
        .image-viewer-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1001;
            flex-direction: column;
        }

        .image-viewer-overlay.visible {
            display: flex;
        }

        .image-viewer-header {
            padding: 8px 16px;
            background: #16213e;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #e94560;
        }

        .image-viewer-header .filename {
            flex: 1;
            color: #e94560;
            font-weight: bold;
            font-size: 14px;
        }

        .image-viewer-header .btn {
            padding: 6px 12px;
            min-width: auto;
        }

        .image-viewer-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            overflow: auto;
            background: #000;
        }

        .image-viewer-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-viewer-container.fullscreen img {
            max-width: none;
            max-height: none;
        }

        /* Video Player Modal */
        .video-player-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1001;
            flex-direction: column;
        }

        .video-player-overlay.visible {
            display: flex;
        }

        .video-player-header {
            padding: 8px 16px;
            background: #16213e;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #e94560;
        }

        .video-player-header .filename {
            flex: 1;
            color: #e94560;
            font-weight: bold;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .video-player-header .btn {
            padding: 6px 12px;
            min-width: auto;
        }

        .video-player-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: #000;
        }

        .video-player-container video {
            max-width: 100%;
            max-height: 100%;
        }

        .video-player-container.fullscreen video {
            max-width: none;
            max-height: none;
            width: 100%;
            height: 100%;
        }

        /* Filer open state */
        #app.filer-open {
            margin-right: 300px;
            transition: margin-right 0.3s ease;
        }

        /* Mobile: filer takes full width */
        @media (max-width: 480px) {
            .filer-panel {
                width: 100%;
            }
            #app.filer-open {
                margin-right: 0;
            }
            .filer-toggle-btn {
                padding: 8px 6px;
                font-size: 11px;
            }
        }
    </style>
    <!-- highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/atom-one-dark.min.css">
</head>
<body>
    <!-- File Browser Toggle Button -->
    <button class="filer-toggle-btn" id="filerToggleBtn">Files</button>

    <!-- File Browser Side Panel -->
    <div class="filer-panel" id="filerPanel">
        <div class="filer-header">
            <button class="btn" id="filerBackBtn">‚Üë</button>
            <button class="btn" id="filerRefreshBtn">‚Üª</button>
            <h3>File Browser</h3>
            <button class="btn" id="filerCloseBtn">√ó</button>
        </div>
        <div class="filer-path" id="filerPath">/</div>
        <div class="filer-list" id="filerList"></div>
        <div class="filer-footer">
            <label>
                <input type="checkbox" id="showHiddenFiles"> Show hidden files
            </label>
        </div>
    </div>

    <div id="app">
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Initializing...</span>
            </div>
            <span id="termSize">--x--</span>
        </div>

        <div id="debug"></div>

        <div id="terminal-container">
            <div id="terminal"></div>
        </div>

        <div class="control-panel">
            <div class="control-main">
                <div class="arrow-section">
                    <div class="arrow-pad">
                        <button class="btn arrow" id="upBtn">‚Üë</button>
                        <button class="btn arrow" id="leftBtn">‚Üê</button>
                        <button class="btn arrow" id="downBtn">‚Üì</button>
                        <button class="btn arrow" id="rightBtn">‚Üí</button>
                    </div>
                    <div class="page-keys">
                        <button class="btn" id="ctrlLeftBtn">^‚Üê</button>
                        <button class="btn" id="ctrlRightBtn">^‚Üí</button>
                    </div>
                    <div class="page-keys">
                        <button class="btn" id="pgupBtn">PgUp</button>
                        <button class="btn" id="pgdnBtn">PgDn</button>
                    </div>
                </div>
                <div class="other-keys">
                    <!-- iPhone: essential keys only -->
                    <div class="button-row iphone-essential">
                        <button class="btn" id="escBtn">Esc</button>
                        <button class="btn" id="tabBtn">Tab</button>
                        <button class="btn" id="shiftTabBtn">S-Tab</button>
                        <button class="btn wide" id="textInputBtn">Text</button>
                        <button class="btn" id="delBtn">Del</button>
                        <button class="btn" id="bsBtn">BS</button>
                        <button class="btn iphone-only" id="moreBtn">More</button>
                    </div>
                    <div class="button-row iphone-hide">
                        <button class="btn" id="ctrlKeyBtn">Ctrl</button>
                        <button class="btn" id="ctrlCBtn">^C</button>
                        <button class="btn" id="ctrlDBtn">^D</button>
                        <button class="btn" id="ctrlZBtn">^Z</button>
                        <button class="btn" id="ctrlXBtn">^X</button>
                        <button class="btn" id="ctrlOBtn">^O</button>
                        <button class="btn" id="ctrlTBtn">^T</button>
                    </div>
                    <div class="button-row iphone-hide">
                        <button class="btn wide" id="tmuxBtn">tmux</button>
                        <button class="btn wide" id="qwertyBtn">KB</button>
                        <button class="btn quick-cmd" id="lsBtn">ls</button>
                        <button class="btn quick-cmd" id="cdBtn">cd ..</button>
                    </div>
                </div>
                <button class="btn enter-btn" id="enterBtn">Enter</button>
            </div>

            <!-- iPhone: extra keys panel -->
            <div class="extra-panel" id="extraPanel">
                <div class="button-row">
                    <button class="btn" id="ctrlKeyBtn2">Ctrl</button>
                    <button class="btn" id="ctrlCBtn2">^C</button>
                    <button class="btn" id="ctrlDBtn2">^D</button>
                    <button class="btn" id="ctrlZBtn2">^Z</button>
                    <button class="btn" id="ctrlXBtn2">^X</button>
                    <button class="btn" id="ctrlOBtn2">^O</button>
                    <button class="btn" id="ctrlTBtn2">^T</button>
                </div>
                <div class="button-row" style="margin-top: 6px;">
                    <button class="btn wide" id="tmuxBtn2">tmux</button>
                </div>
            </div>

            <div class="tmux-panel" id="tmuxPanel">
                <div class="section-label">tmux (Ctrl+B + key)</div>
                <div class="button-row">
                    <button class="btn" data-tmux="c">c (new)</button>
                    <button class="btn" data-tmux="n">n (next)</button>
                    <button class="btn" data-tmux="p">p (prev)</button>
                    <button class="btn" data-tmux="d">d (detach)</button>
                    <button class="btn" data-tmux="%">% (vsplit)</button>
                    <button class="btn" data-tmux='"'>" (hsplit)</button>
                </div>
                <div class="button-row" style="margin-top: 6px;">
                    <button class="btn" data-tmux="o">o (pane)</button>
                    <button class="btn" data-tmux="x">x (kill)</button>
                    <button class="btn" data-tmux="z">z (zoom)</button>
                    <button class="btn" data-tmux="s">s (sessions)</button>
                    <button class="btn" data-tmux="w">w (windows)</button>
                </div>
                <div class="section-label" style="margin-top: 8px;">Scroll mode</div>
                <div class="button-row">
                    <button class="btn" data-tmux="[">[ (scroll)</button>
                    <button class="btn" id="tmuxQuitBtn">q (quit)</button>
                </div>
            </div>

            <div class="qwerty-panel" id="qwertyPanel">
                <div class="qwerty-row">
                    <button class="qwerty-btn" data-key="1">1</button>
                    <button class="qwerty-btn" data-key="2">2</button>
                    <button class="qwerty-btn" data-key="3">3</button>
                    <button class="qwerty-btn" data-key="4">4</button>
                    <button class="qwerty-btn" data-key="5">5</button>
                    <button class="qwerty-btn" data-key="6">6</button>
                    <button class="qwerty-btn" data-key="7">7</button>
                    <button class="qwerty-btn" data-key="8">8</button>
                    <button class="qwerty-btn" data-key="9">9</button>
                    <button class="qwerty-btn" data-key="0">0</button>
                </div>
                <div class="qwerty-row">
                    <button class="qwerty-btn" data-key="q">q</button>
                    <button class="qwerty-btn" data-key="w">w</button>
                    <button class="qwerty-btn" data-key="e">e</button>
                    <button class="qwerty-btn" data-key="r">r</button>
                    <button class="qwerty-btn" data-key="t">t</button>
                    <button class="qwerty-btn" data-key="y">y</button>
                    <button class="qwerty-btn" data-key="u">u</button>
                    <button class="qwerty-btn" data-key="i">i</button>
                    <button class="qwerty-btn" data-key="o">o</button>
                    <button class="qwerty-btn" data-key="p">p</button>
                </div>
                <div class="qwerty-row">
                    <button class="qwerty-btn" data-key="a">a</button>
                    <button class="qwerty-btn" data-key="s">s</button>
                    <button class="qwerty-btn" data-key="d">d</button>
                    <button class="qwerty-btn" data-key="f">f</button>
                    <button class="qwerty-btn" data-key="g">g</button>
                    <button class="qwerty-btn" data-key="h">h</button>
                    <button class="qwerty-btn" data-key="j">j</button>
                    <button class="qwerty-btn" data-key="k">k</button>
                    <button class="qwerty-btn" data-key="l">l</button>
                </div>
                <div class="qwerty-row">
                    <button class="qwerty-btn medium" id="shiftBtn">Shift</button>
                    <button class="qwerty-btn" data-key="z">z</button>
                    <button class="qwerty-btn" data-key="x">x</button>
                    <button class="qwerty-btn" data-key="c">c</button>
                    <button class="qwerty-btn" data-key="v">v</button>
                    <button class="qwerty-btn" data-key="b">b</button>
                    <button class="qwerty-btn" data-key="n">n</button>
                    <button class="qwerty-btn" data-key="m">m</button>
                    <button class="qwerty-btn" data-key="/">/ </button>
                </div>
                <div class="qwerty-row">
                    <button class="qwerty-btn" data-key="-">-</button>
                    <button class="qwerty-btn" data-key="=">=</button>
                    <button class="qwerty-btn space" data-key=" ">Space</button>
                    <button class="qwerty-btn" data-key=".">.</button>
                    <button class="qwerty-btn" data-key=",">,</button>
                </div>
            </div>

            <!-- Custom buttons (loaded from ~/.nagi/buttons.html) -->
            <div class="custom-panel" id="customPanel"><!-- CUSTOM_BUTTONS --></div>
        </div>
    </div>

    <div class="modal-overlay" id="textModal">
        <div class="modal">
            <h3>Text Input</h3>
            <textarea id="textInput" placeholder="Type or paste text here..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="cancelText">Cancel</button>
                <button class="modal-btn send" id="sendText">Send</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="ctrlModal">
        <div class="modal ctrl-keyboard">
            <h3>Ctrl + ?</h3>
            <div class="keyboard-row">
                <button class="kbd-btn" data-ctrl="Q">Q</button>
                <button class="kbd-btn" data-ctrl="W">W</button>
                <button class="kbd-btn" data-ctrl="E">E</button>
                <button class="kbd-btn" data-ctrl="R">R</button>
                <button class="kbd-btn" data-ctrl="T">T</button>
                <button class="kbd-btn" data-ctrl="Y">Y</button>
                <button class="kbd-btn" data-ctrl="U">U</button>
                <button class="kbd-btn" data-ctrl="I">I</button>
                <button class="kbd-btn" data-ctrl="O">O</button>
                <button class="kbd-btn" data-ctrl="P">P</button>
            </div>
            <div class="keyboard-row">
                <button class="kbd-btn" data-ctrl="A">A</button>
                <button class="kbd-btn" data-ctrl="S">S</button>
                <button class="kbd-btn" data-ctrl="D">D</button>
                <button class="kbd-btn" data-ctrl="F">F</button>
                <button class="kbd-btn" data-ctrl="G">G</button>
                <button class="kbd-btn" data-ctrl="H">H</button>
                <button class="kbd-btn" data-ctrl="J">J</button>
                <button class="kbd-btn" data-ctrl="K">K</button>
                <button class="kbd-btn" data-ctrl="L">L</button>
            </div>
            <div class="keyboard-row">
                <button class="kbd-btn" data-ctrl="Z">Z</button>
                <button class="kbd-btn" data-ctrl="X">X</button>
                <button class="kbd-btn" data-ctrl="C">C</button>
                <button class="kbd-btn" data-ctrl="V">V</button>
                <button class="kbd-btn" data-ctrl="B">B</button>
                <button class="kbd-btn" data-ctrl="N">N</button>
                <button class="kbd-btn" data-ctrl="M">M</button>
            </div>
            <div class="keyboard-row">
                <button class="kbd-btn wide" id="ctrlModalCancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- File Viewer Modal -->
    <div class="file-viewer-overlay" id="fileViewerOverlay">
        <div class="file-viewer-header">
            <span class="filename" id="fileViewerName">filename.py</span>
            <button class="btn" id="fileViewerCloseBtn">√ó</button>
        </div>
        <div class="file-viewer-content" id="fileViewerContent">
            <pre><code id="fileViewerCode"></code></pre>
        </div>
    </div>

    <!-- Video Player Modal -->
    <div class="video-player-overlay" id="videoPlayerOverlay">
        <div class="video-player-header">
            <span class="filename" id="videoPlayerName">video.mp4</span>
            <button class="btn" id="videoFullscreenBtn">‚õ∂</button>
            <button class="btn" id="videoPlayerCloseBtn">√ó</button>
        </div>
        <div class="video-player-container" id="videoPlayerContainer">
            <video id="videoPlayer" controls></video>
        </div>
    </div>

    <!-- Image Viewer Modal -->
    <div class="image-viewer-overlay" id="imageViewerOverlay">
        <div class="image-viewer-header">
            <span class="filename" id="imageViewerName">image.png</span>
            <button class="btn" id="imageFullscreenBtn">‚õ∂</button>
            <button class="btn" id="imageViewerCloseBtn">√ó</button>
        </div>
        <div class="image-viewer-container" id="imageViewerContainer">
            <img id="imageViewer" src="" alt="">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.min.js"></script>
    <!-- highlight.js with all common languages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
    <script>
        const NAGI_VERSION = '1.1.20';
        console.log(`Nagi Terminal v${NAGI_VERSION}`);

        const debugEl = document.getElementById('debug');
        function log(msg) {
            console.log(msg);
            debugEl.style.display = 'block';
            debugEl.textContent += msg + '\n';
            debugEl.scrollTop = debugEl.scrollHeight;
        }

        // Idle detection and notification settings
        const IDLE_TIMEOUT = 3000; // 3 seconds of no display change = waiting state
        let idleCheckInterval = null;
        let lastDisplayContent = '';
        let lastChangeTime = Date.now();
        let isIdle = false;
        let wasActive = false; // Track if there was activity before going idle
        let notificationShown = false; // Only notify once until user interacts
        let notificationSupported = false;

        // Get terminal display content as string for comparison
        function getTerminalContent() {
            if (!term || !term.buffer || !term.buffer.active) return '';
            const buffer = term.buffer.active;
            let content = '';
            for (let i = 0; i < buffer.length; i++) {
                const line = buffer.getLine(i);
                if (line) {
                    content += line.translateToString(true) + '\n';
                }
            }
            return content;
        }

        // Check if terminal display has changed
        function checkDisplayChange() {
            const currentContent = getTerminalContent();
            const contentLength = currentContent.length;

            if (currentContent !== lastDisplayContent) {
                // Display changed
                const prevLength = lastDisplayContent.length;
                lastDisplayContent = currentContent;
                lastChangeTime = Date.now();

                console.log(`Display changed: ${prevLength} -> ${contentLength} chars`);

                if (isIdle) {
                    console.log('Was idle, now active');
                }
                isIdle = false;
                wasActive = true;
                stopTitleFlash();
            } else {
                // Display hasn't changed
                const idleTime = Date.now() - lastChangeTime;

                if (!isIdle && wasActive && idleTime >= IDLE_TIMEOUT) {
                    // Just became idle
                    isIdle = true;
                    console.log(`*** IDLE DETECTED *** (no change for ${idleTime}ms, content: ${contentLength} chars)`);

                    // Only notify once until user interacts
                    if (!notificationShown) {
                        notificationShown = true;
                        playNotificationSound();
                        showIdleNotification();
                    }
                }
            }
        }

        // Request notification permission
        if ('Notification' in window) {
            if (Notification.permission === 'granted') {
                notificationSupported = true;
                console.log('Notifications: granted');
            } else if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    notificationSupported = (permission === 'granted');
                    console.log('Notifications:', permission);
                });
            } else {
                console.log('Notifications: denied');
            }
        } else {
            console.log('Notifications: not supported (iOS Safari)');
        }

        // Audio context for notification sound
        let audioContext = null;
        function getAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        // Initialize audio context on first user interaction (required for iOS)
        function initAudioOnInteraction() {
            try {
                const ctx = getAudioContext();
                if (ctx.state === 'suspended') {
                    ctx.resume();
                }
                // Create a silent buffer to unlock audio
                const buffer = ctx.createBuffer(1, 1, 22050);
                const source = ctx.createBufferSource();
                source.buffer = buffer;
                source.connect(ctx.destination);
                source.start(0);
            } catch (e) {
                console.log('Audio init:', e);
            }
            // Remove listeners after first interaction
            document.removeEventListener('touchstart', initAudioOnInteraction);
            document.removeEventListener('click', initAudioOnInteraction);
        }
        document.addEventListener('touchstart', initAudioOnInteraction, { once: true });
        document.addEventListener('click', initAudioOnInteraction, { once: true });

        // Play notification sound (pleasant chime)
        function playNotificationSound() {
            try {
                const ctx = getAudioContext();
                if (ctx.state === 'suspended') {
                    ctx.resume();
                }

                const now = ctx.currentTime;

                // Create a pleasant two-tone chime
                const frequencies = [65.41, 82.41]; // C2 and E2 (deep tone)

                frequencies.forEach((freq, i) => {
                    const oscillator = ctx.createOscillator();
                    const gainNode = ctx.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(ctx.destination);

                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(freq, now);

                    // Envelope: quick attack, gradual decay
                    gainNode.gain.setValueAtTime(0, now + i * 0.15);
                    gainNode.gain.linearRampToValueAtTime(0.3, now + i * 0.15 + 0.05);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + i * 0.15 + 0.5);

                    oscillator.start(now + i * 0.15);
                    oscillator.stop(now + i * 0.15 + 0.5);
                });
            } catch (e) {
                console.log('Could not play notification sound:', e);
            }
        }

        // Show browser notification
        let titleFlashInterval = null;
        let originalTitle = '';

        function showIdleNotification() {
            const host = window.NAGI_HOST || 'Nagi';

            // Try Web Notification API (not supported on iOS Safari)
            if (notificationSupported) {
                try {
                    const notification = new Notification('Terminal Ready', {
                        body: `${host} is waiting for input`,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">‚å®Ô∏è</text></svg>',
                        tag: 'nagi-idle',
                        requireInteraction: false
                    });

                    setTimeout(() => notification.close(), 5000);

                    notification.onclick = () => {
                        window.focus();
                        notification.close();
                    };
                    console.log('Notification shown');
                } catch (e) {
                    console.log('Notification error:', e);
                }
            }

            // Flash title for all browsers (works on iOS too)
            if (!titleFlashInterval) {
                originalTitle = document.title;
                let flash = true;
                titleFlashInterval = setInterval(() => {
                    document.title = flash ? 'üîî Terminal Ready!' : originalTitle;
                    flash = !flash;
                }, 1000);
                console.log('Title flash started');
            }
        }

        function stopTitleFlash() {
            if (titleFlashInterval) {
                clearInterval(titleFlashInterval);
                titleFlashInterval = null;
                if (originalTitle) {
                    document.title = originalTitle;
                }
            }
        }

        // Start idle detection interval (check every 500ms)
        function startIdleDetection() {
            if (!idleCheckInterval) {
                lastDisplayContent = getTerminalContent();
                lastChangeTime = Date.now();
                idleCheckInterval = setInterval(checkDisplayChange, 500);
                console.log(`Idle detection started (initial content: ${lastDisplayContent.length} chars, timeout: ${IDLE_TIMEOUT}ms)`);
            }
        }

        function stopIdleDetection() {
            if (idleCheckInterval) {
                clearInterval(idleCheckInterval);
                idleCheckInterval = null;
            }
        }

        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        let term, fitAddon, ws;

        try {
            log('Creating Terminal...');
            term = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                theme: {
                    background: '#1a1a2e',
                    foreground: '#eee',
                    cursor: '#e94560',
                },
                allowProposedApi: true
            });

            log('Creating FitAddon...');
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);

            log('Creating WebLinksAddon...');
            const webLinksAddon = new WebLinksAddon.WebLinksAddon((event, uri) => {
                window.open(uri, '_blank');
            });
            term.loadAddon(webLinksAddon);

            log('Opening terminal...');
            term.open(document.getElementById('terminal'));

            // Fix for iOS third-party IME (e.g., ATOK) where composition events don't fire
            // Block multi-char keypress to prevent xterm.js from sending only first char
            term.attachCustomKeyEventHandler((ev) => {
                if (ev.type === 'keypress' && ev.key && ev.key.length > 1) {
                    return false;
                }
                return true;
            });

            // Send input directly when composition events don't fire (iOS IME issue)
            const xtermTextarea = document.querySelector('.xterm-helper-textarea');
            if (xtermTextarea) {
                xtermTextarea.addEventListener('input', (e) => {
                    if (!e.isComposing && e.data && e.data.length > 1) {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            ws.send(e.data);
                        }
                        setTimeout(() => { xtermTextarea.value = ''; }, 0);
                    }
                }, true);
            }

            log('Fitting terminal...');
            fitAddon.fit();
            document.getElementById('termSize').textContent = `${term.cols}x${term.rows}`;

            log('Terminal ready: ' + term.cols + 'x' + term.rows);
            statusText.textContent = 'Connecting...';

        } catch (e) {
            log('ERROR: ' + e.message);
            statusText.textContent = 'Init Error';
        }

        function fitTerminal() {
            if (fitAddon) {
                fitAddon.fit();
                document.getElementById('termSize').textContent = `${term.cols}x${term.rows}`;
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(`resize:${term.cols},${term.rows}`);
                }
            }
        }

        window.addEventListener('resize', fitTerminal);

        function connect() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const token = window.NAGI_TOKEN || '';
                const url = `${protocol}//${window.location.host}/ws?token=${token}`;
                log('Connecting to ' + url);

                ws = new WebSocket(url);
                ws.binaryType = 'arraybuffer';

                ws.onopen = () => {
                    log('WebSocket connected');
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Connected';
                    debugEl.style.display = 'none';
                    fitTerminal();
                    // Set window title with hostname and IP
                    const host = window.NAGI_HOST || 'Nagi';
                    const ip = window.NAGI_IP || '';
                    document.title = ip ? `${host} (${ip}) - Nagi` : `${host} - Nagi`;
                    // Start idle detection
                    startIdleDetection();
                };

                ws.onclose = (e) => {
                    log('WebSocket closed: ' + e.code);
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'Disconnected';
                    stopIdleDetection();
                    setTimeout(connect, 2000);
                };

                ws.onerror = (e) => {
                    log('WebSocket error');
                    statusText.textContent = 'Error';
                };

                ws.onmessage = (event) => {
                    if (event.data instanceof ArrayBuffer) {
                        const decoder = new TextDecoder();
                        term.write(decoder.decode(event.data));
                    } else {
                        term.write(event.data);
                    }
                };
            } catch (e) {
                log('Connect error: ' + e.message);
            }
        }

        if (term) {
            connect();
        }

        function send(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                // Reset notification flag on user interaction
                notificationShown = false;
                ws.send(typeof data === 'string' ? data : new Uint8Array(data));
            }
        }

        if (term) {
            term.onData((data) => {
                // Filter out terminal response sequences that shouldn't be sent back to PTY
                // DA1 response: ESC [ ? ... c
                // DA2 response: ESC [ > ... c  (e.g., \x1b[>0;276;0c)
                // DSR response (cursor position): ESC [ ... R
                // Also filter incomplete responses where ESC may have been dropped
                if (/^\x1b\[[?>]?[0-9;]*[cR]$/.test(data) || /^[?>][0-9;]*c$/.test(data)) {
                    return; // Don't send terminal responses back to PTY
                }
                send(data);
            });
        }

        // Key repeat for arrow keys (1 second delay, then repeat)
        let repeatTimer = null;
        let repeatInterval = null;
        const REPEAT_DELAY = 1000;  // 1 second before repeat starts
        const REPEAT_RATE = 100;    // 100ms between repeats

        function setupRepeatableKey(btn, data) {
            const startRepeat = () => {
                send(data);
                repeatTimer = setTimeout(() => {
                    repeatInterval = setInterval(() => send(data), REPEAT_RATE);
                }, REPEAT_DELAY);
            };
            const stopRepeat = () => {
                if (repeatTimer) { clearTimeout(repeatTimer); repeatTimer = null; }
                if (repeatInterval) { clearInterval(repeatInterval); repeatInterval = null; }
            };
            btn.addEventListener('mousedown', startRepeat);
            btn.addEventListener('mouseup', stopRepeat);
            btn.addEventListener('mouseleave', stopRepeat);
            btn.addEventListener('touchstart', (e) => { e.preventDefault(); startRepeat(); });
            btn.addEventListener('touchend', stopRepeat);
            btn.addEventListener('touchcancel', stopRepeat);
        }

        // Essential keys (both modes)
        document.getElementById('escBtn').addEventListener('click', () => send('\x1b'));
        document.getElementById('enterBtn').addEventListener('click', () => send('\r'));
        document.getElementById('bsBtn').addEventListener('click', () => send('\x7f'));

        // Arrow keys with repeat
        setupRepeatableKey(document.getElementById('upBtn'), '\x1b[A');
        setupRepeatableKey(document.getElementById('downBtn'), '\x1b[B');
        setupRepeatableKey(document.getElementById('rightBtn'), '\x1b[C');
        setupRepeatableKey(document.getElementById('leftBtn'), '\x1b[D');

        // Desktop keys
        const tabBtn = document.getElementById('tabBtn');
        const pgupBtn = document.getElementById('pgupBtn');
        const pgdnBtn = document.getElementById('pgdnBtn');
        const delBtn = document.getElementById('delBtn');
        const ctrlCBtn = document.getElementById('ctrlCBtn');
        const ctrlDBtn = document.getElementById('ctrlDBtn');
        const ctrlZBtn = document.getElementById('ctrlZBtn');
        const lsBtn = document.getElementById('lsBtn');
        const cdBtn = document.getElementById('cdBtn');

        if (tabBtn) tabBtn.addEventListener('click', () => send('\t'));

        // Shift+Tab
        const shiftTabBtn = document.getElementById('shiftTabBtn');
        if (shiftTabBtn) shiftTabBtn.addEventListener('click', () => send('\x1b[Z'));
        if (pgupBtn) pgupBtn.addEventListener('click', () => send('\x1b[5~'));
        if (pgdnBtn) pgdnBtn.addEventListener('click', () => send('\x1b[6~'));

        // Ctrl+Arrow keys (word jump)
        const ctrlLeftBtn = document.getElementById('ctrlLeftBtn');
        const ctrlRightBtn = document.getElementById('ctrlRightBtn');
        if (ctrlLeftBtn) ctrlLeftBtn.addEventListener('click', () => send('\x1b[1;5D'));
        if (ctrlRightBtn) ctrlRightBtn.addEventListener('click', () => send('\x1b[1;5C'));
        if (delBtn) delBtn.addEventListener('click', () => send('\x1b[3~'));
        if (ctrlCBtn) ctrlCBtn.addEventListener('click', () => send('\x03'));
        if (ctrlDBtn) ctrlDBtn.addEventListener('click', () => send('\x04'));
        if (ctrlZBtn) ctrlZBtn.addEventListener('click', () => send('\x1a'));

        // Ctrl+X
        const ctrlXBtn = document.getElementById('ctrlXBtn');
        if (ctrlXBtn) ctrlXBtn.addEventListener('click', () => send('\x18'));

        // Claude Code keys
        const ctrlOBtn = document.getElementById('ctrlOBtn');
        const ctrlTBtn = document.getElementById('ctrlTBtn');
        if (ctrlOBtn) ctrlOBtn.addEventListener('click', () => send('\x0f'));
        if (ctrlTBtn) ctrlTBtn.addEventListener('click', () => send('\x14'));

        if (lsBtn) lsBtn.addEventListener('click', () => send('ls\n'));
        if (cdBtn) cdBtn.addEventListener('click', () => send('cd ..\n'));

        // iPhone extra panel keys
        const ctrlCBtn2 = document.getElementById('ctrlCBtn2');
        const ctrlDBtn2 = document.getElementById('ctrlDBtn2');
        const ctrlZBtn2 = document.getElementById('ctrlZBtn2');

        if (ctrlCBtn2) ctrlCBtn2.addEventListener('click', () => send('\x03'));
        if (ctrlDBtn2) ctrlDBtn2.addEventListener('click', () => send('\x04'));
        if (ctrlZBtn2) ctrlZBtn2.addEventListener('click', () => send('\x1a'));

        // Ctrl+X (iPhone)
        const ctrlXBtn2 = document.getElementById('ctrlXBtn2');
        if (ctrlXBtn2) ctrlXBtn2.addEventListener('click', () => send('\x18'));

        // Claude Code keys (iPhone)
        const ctrlOBtn2 = document.getElementById('ctrlOBtn2');
        const ctrlTBtn2 = document.getElementById('ctrlTBtn2');
        if (ctrlOBtn2) ctrlOBtn2.addEventListener('click', () => send('\x0f'));
        if (ctrlTBtn2) ctrlTBtn2.addEventListener('click', () => send('\x14'));

        // More button for iPhone
        const moreBtn = document.getElementById('moreBtn');
        const extraPanel = document.getElementById('extraPanel');
        if (moreBtn) {
            moreBtn.addEventListener('click', () => {
                extraPanel.classList.toggle('visible');
                moreBtn.textContent = extraPanel.classList.contains('visible') ? 'Less' : 'More';
            });
        }

        // tmux buttons
        const tmuxBtn = document.getElementById('tmuxBtn');
        const tmuxBtn2 = document.getElementById('tmuxBtn2');
        const tmuxPanel = document.getElementById('tmuxPanel');

        if (tmuxBtn) tmuxBtn.addEventListener('click', () => tmuxPanel.classList.toggle('visible'));
        if (tmuxBtn2) tmuxBtn2.addEventListener('click', () => tmuxPanel.classList.toggle('visible'));

        document.querySelectorAll('[data-tmux]').forEach(btn => {
            btn.addEventListener('click', () => send('\x02' + btn.dataset.tmux));
        });

        // Custom buttons handlers (from ~/.nagi/buttons.html)
        // data-send: send text directly (e.g., data-send="ls -la\n")
        document.querySelectorAll('[data-send]').forEach(btn => {
            btn.addEventListener('click', () => {
                const text = btn.dataset.send.replace(/\\n/g, '\n').replace(/\\t/g, '\t');
                send(text);
            });
        });
        // data-ctrl: send Ctrl+key (e.g., data-ctrl="c" for Ctrl+C)
        document.querySelectorAll('[data-ctrl]').forEach(btn => {
            btn.addEventListener('click', () => {
                const key = btn.dataset.ctrl.toLowerCase();
                const code = key.charCodeAt(0) - 96; // a=1, b=2, etc.
                if (code > 0 && code < 27) {
                    send(String.fromCharCode(code));
                }
            });
        });
        // data-cmd: send command + Enter (e.g., data-cmd="ls -la")
        document.querySelectorAll('[data-cmd]').forEach(btn => {
            btn.addEventListener('click', () => send(btn.dataset.cmd + '\n'));
        });

        // tmux scroll mode quit (sends 'q' without Ctrl+B prefix)
        const tmuxQuitBtn = document.getElementById('tmuxQuitBtn');
        if (tmuxQuitBtn) tmuxQuitBtn.addEventListener('click', () => send('q'));

        // QWERTY keyboard toggle
        const qwertyBtn = document.getElementById('qwertyBtn');
        const qwertyPanel = document.getElementById('qwertyPanel');
        let shiftActive = false;
        const shiftBtn = document.getElementById('shiftBtn');

        const terminalContainer = document.getElementById('terminal-container');
        const appContainer = document.getElementById('app');
        if (qwertyBtn) {
            qwertyBtn.addEventListener('click', () => {
                qwertyPanel.classList.toggle('visible');
                const isVisible = qwertyPanel.classList.contains('visible');
                qwertyBtn.textContent = isVisible ? 'KB ‚úì' : 'KB';
                // Adjust terminal size when keyboard is shown/hidden
                if (isVisible) {
                    terminalContainer.style.flex = '0 0 55vh';
                    appContainer.style.overflow = 'auto';
                } else {
                    terminalContainer.style.flex = '1';
                    appContainer.style.overflow = 'hidden';
                }
                // Refit terminal after layout change
                setTimeout(() => {
                    fitTerminal();
                    if (isVisible) {
                        qwertyPanel.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }
                }, 50);
            });
        }

        // Shift mappings for symbols
        const shiftMap = {
            '1': '!', '2': '@', '3': '#', '4': '$', '5': '%',
            '6': '^', '7': '&', '8': '*', '9': '(', '0': ')',
            '-': '_', '=': '+', '/': '?', '.': '>', ',': '<'
        };

        // Update key labels based on shift state
        function updateKeyLabels() {
            document.querySelectorAll('[data-key]').forEach(btn => {
                const key = btn.dataset.key;
                if (key === ' ') return; // Skip space bar
                if (key.match(/^[a-z]$/)) {
                    btn.textContent = shiftActive ? key.toUpperCase() : key;
                } else if (shiftMap[key]) {
                    btn.textContent = shiftActive ? shiftMap[key] : key;
                }
            });
        }

        // Shift toggle
        if (shiftBtn) {
            shiftBtn.addEventListener('click', () => {
                shiftActive = !shiftActive;
                shiftBtn.style.background = shiftActive ? '#e94560' : '#0f3460';
                shiftBtn.style.color = shiftActive ? '#16213e' : '#e94560';
                updateKeyLabels();
            });
        }

        // QWERTY key handling
        document.querySelectorAll('[data-key]').forEach(btn => {
            btn.addEventListener('click', () => {
                let key = btn.dataset.key;
                if (shiftActive) {
                    if (key.match(/^[a-z]$/)) {
                        key = key.toUpperCase();
                    } else if (shiftMap[key]) {
                        key = shiftMap[key];
                    }
                }
                send(key);
            });
        });

        const textModal = document.getElementById('textModal');
        const textInput = document.getElementById('textInput');
        document.getElementById('textInputBtn').addEventListener('click', () => {
            textModal.classList.add('visible');
            textInput.focus();
        });

        // Ctrl keyboard modal
        const ctrlModal = document.getElementById('ctrlModal');
        const ctrlKeyBtn = document.getElementById('ctrlKeyBtn');
        const ctrlKeyBtn2 = document.getElementById('ctrlKeyBtn2');
        if (ctrlKeyBtn) {
            ctrlKeyBtn.addEventListener('click', () => {
                ctrlModal.classList.add('visible');
            });
        }
        if (ctrlKeyBtn2) {
            ctrlKeyBtn2.addEventListener('click', () => {
                ctrlModal.classList.add('visible');
            });
        }
        document.getElementById('ctrlModalCancel').addEventListener('click', () => {
            ctrlModal.classList.remove('visible');
        });
        document.querySelectorAll('[data-ctrl]').forEach(btn => {
            btn.addEventListener('click', () => {
                const key = btn.dataset.ctrl;
                const code = key.charCodeAt(0) - 64;  // A=1, B=2, ... Z=26
                send(String.fromCharCode(code));
                ctrlModal.classList.remove('visible');
            });
        });
        ctrlModal.addEventListener('click', (e) => {
            if (e.target === ctrlModal) {
                ctrlModal.classList.remove('visible');
            }
        });
        document.getElementById('cancelText').addEventListener('click', () => {
            textModal.classList.remove('visible');
            textInput.value = '';
        });
        document.getElementById('sendText').addEventListener('click', () => {
            if (textInput.value) send(textInput.value);
            textModal.classList.remove('visible');
            textInput.value = '';
        });
        textInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                document.getElementById('sendText').click();
            }
        });

        document.addEventListener('dblclick', (e) => e.preventDefault(), { passive: false });
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // Reset idle state when returning to the page
                isIdle = false;
                wasActive = false;
                lastChangeTime = Date.now();
                lastDisplayContent = getTerminalContent();

                // Stop title flash
                stopTitleFlash();

                // Reconnect if disconnected
                if (ws && ws.readyState !== WebSocket.OPEN) {
                    connect();
                }
            }
        });

        // Close panels when tapping outside
        document.addEventListener('click', (e) => {
            // Close extra panel if clicking outside of it
            if (extraPanel && extraPanel.classList.contains('visible')) {
                if (!extraPanel.contains(e.target) && e.target !== moreBtn) {
                    extraPanel.classList.remove('visible');
                    if (moreBtn) moreBtn.textContent = 'More';
                }
            }
            // Close tmux panel if clicking outside of it
            if (tmuxPanel && tmuxPanel.classList.contains('visible')) {
                if (!tmuxPanel.contains(e.target) && e.target !== tmuxBtn && e.target !== tmuxBtn2) {
                    tmuxPanel.classList.remove('visible');
                }
            }
        });

        // ========================================
        // File Browser Functionality
        // ========================================

        const filerPanel = document.getElementById('filerPanel');
        const filerToggleBtn = document.getElementById('filerToggleBtn');
        const filerCloseBtn = document.getElementById('filerCloseBtn');
        const filerBackBtn = document.getElementById('filerBackBtn');
        const filerRefreshBtn = document.getElementById('filerRefreshBtn');
        const filerPath = document.getElementById('filerPath');
        const filerList = document.getElementById('filerList');
        const showHiddenFiles = document.getElementById('showHiddenFiles');

        const fileViewerOverlay = document.getElementById('fileViewerOverlay');
        const fileViewerName = document.getElementById('fileViewerName');
        const fileViewerCode = document.getElementById('fileViewerCode');
        const fileViewerCloseBtn = document.getElementById('fileViewerCloseBtn');

        const videoPlayerOverlay = document.getElementById('videoPlayerOverlay');
        const videoPlayerName = document.getElementById('videoPlayerName');
        const videoPlayer = document.getElementById('videoPlayer');
        const videoPlayerContainer = document.getElementById('videoPlayerContainer');
        const videoPlayerCloseBtn = document.getElementById('videoPlayerCloseBtn');
        const videoFullscreenBtn = document.getElementById('videoFullscreenBtn');

        const imageViewerOverlay = document.getElementById('imageViewerOverlay');
        const imageViewerName = document.getElementById('imageViewerName');
        const imageViewer = document.getElementById('imageViewer');
        const imageViewerContainer = document.getElementById('imageViewerContainer');
        const imageViewerCloseBtn = document.getElementById('imageViewerCloseBtn');
        const imageFullscreenBtn = document.getElementById('imageFullscreenBtn');

        let currentFilerPath = null;

        // Extension to highlight.js language mapping
        const LANG_MAP = {
            '.py': 'python',
            '.js': 'javascript',
            '.ts': 'typescript',
            '.jsx': 'javascript',
            '.tsx': 'typescript',
            '.json': 'json',
            '.yaml': 'yaml',
            '.yml': 'yaml',
            '.sh': 'bash',
            '.bash': 'bash',
            '.css': 'css',
            '.scss': 'css',
            '.html': 'xml',
            '.xml': 'xml',
            '.go': 'go',
            '.rs': 'rust',
            '.c': 'c',
            '.cpp': 'cpp',
            '.h': 'c',
            '.hpp': 'cpp',
            '.java': 'java',
            '.sql': 'sql',
            '.md': 'markdown'
        };

        // Video extensions
        const VIDEO_EXTENSIONS = ['.mp4', '.webm', '.mov', '.avi', '.mkv', '.m4v'];

        // Image extensions
        const IMAGE_EXTENSIONS = ['.png', '.jpg', '.jpeg', '.gif', '.svg', '.webp', '.bmp'];

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === null || bytes === undefined) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Get file icon
        function getFileIcon(item) {
            if (item.type === 'directory') return '\u{1F4C1}';

            const ext = item.extension;
            if (VIDEO_EXTENSIONS.includes(ext)) return '\u{1F3AC}';
            if (IMAGE_EXTENSIONS.includes(ext)) return '\u{1F5BC}';
            if (['.py'].includes(ext)) return '\u{1F40D}';
            if (['.js', '.ts', '.jsx', '.tsx'].includes(ext)) return '\u{1F4DC}';
            if (['.json', '.yaml', '.yml', '.toml'].includes(ext)) return '\u2699';
            if (['.md', '.txt'].includes(ext)) return '\u{1F4DD}';
            if (['.html', '.css', '.scss'].includes(ext)) return '\u{1F310}';
            if (['.sh', '.bash'].includes(ext)) return '\u{1F4BB}';
            return '\u{1F4C4}';
        }

        // Load files from API
        async function loadFiles(path = null) {
            const token = window.NAGI_TOKEN || '';
            const showHidden = showHiddenFiles.checked;

            let url = `/api/files?token=${encodeURIComponent(token)}&show_hidden=${showHidden}`;
            if (path) {
                url += `&path=${encodeURIComponent(path)}`;
            }

            try {
                filerList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Loading...</div>';

                const response = await fetch(url);
                if (!response.ok) {
                    const error = await response.json();
                    filerList.innerHTML = `<div style="padding: 20px; text-align: center; color: #e94560;">Error: ${error.error}</div>`;
                    return;
                }

                const data = await response.json();
                currentFilerPath = data.path;
                filerPath.textContent = data.path;

                // Render file list
                filerList.innerHTML = '';

                if (data.items.length === 0) {
                    filerList.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Empty directory</div>';
                    return;
                }

                data.items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = `filer-item ${item.type}`;
                    div.innerHTML = `
                        <span class="icon">${getFileIcon(item)}</span>
                        <span class="name">${escapeHtml(item.name)}</span>
                        <span class="size">${formatFileSize(item.size)}</span>
                    `;

                    div.addEventListener('click', () => {
                        if (item.type === 'directory') {
                            loadFiles(currentFilerPath + '/' + item.name);
                        } else if (VIDEO_EXTENSIONS.includes(item.extension)) {
                            openVideoPlayer(currentFilerPath + '/' + item.name, item.name);
                        } else if (IMAGE_EXTENSIONS.includes(item.extension)) {
                            openImageViewer(currentFilerPath + '/' + item.name, item.name);
                        } else {
                            openFileViewer(currentFilerPath + '/' + item.name, item.name, item.extension);
                        }
                    });

                    filerList.appendChild(div);
                });

                // Update back button state
                filerBackBtn.disabled = !data.parent;
                filerBackBtn.style.opacity = data.parent ? '1' : '0.5';

            } catch (error) {
                console.error('Error loading files:', error);
                filerList.innerHTML = '<div style="padding: 20px; text-align: center; color: #e94560;">Failed to load files</div>';
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Open file viewer
        async function openFileViewer(path, name, extension) {
            const token = window.NAGI_TOKEN || '';
            const url = `/api/file?token=${encodeURIComponent(token)}&path=${encodeURIComponent(path)}`;

            try {
                fileViewerName.textContent = name;
                fileViewerCode.textContent = 'Loading...';
                fileViewerCode.className = '';
                fileViewerOverlay.classList.add('visible');

                const response = await fetch(url);
                if (!response.ok) {
                    const error = await response.json();
                    fileViewerCode.textContent = `Error: ${error.error}`;
                    return;
                }

                const data = await response.json();

                // Set code content
                fileViewerCode.textContent = data.content;
                fileViewerCode.className = '';

                // Set language for highlight.js
                const lang = LANG_MAP[extension];
                if (lang && hljs.getLanguage(lang)) {
                    fileViewerCode.classList.add(`language-${lang}`);
                    hljs.highlightElement(fileViewerCode);
                }

            } catch (error) {
                console.error('Error loading file:', error);
                fileViewerCode.textContent = `Failed to load file: ${error.message || error}`;
            }
        }

        // Open video player
        function openVideoPlayer(path, name) {
            const token = window.NAGI_TOKEN || '';
            const url = `/api/video?token=${encodeURIComponent(token)}&path=${encodeURIComponent(path)}`;

            videoPlayerName.textContent = name;
            videoPlayer.src = url;
            videoPlayerOverlay.classList.add('visible');
            videoPlayer.play().catch(() => {});
        }

        // Close video player
        function closeVideoPlayer() {
            videoPlayer.pause();
            videoPlayer.src = '';
            videoPlayerOverlay.classList.remove('visible');
            videoPlayerContainer.classList.remove('fullscreen');
        }

        // Open image viewer
        function openImageViewer(path, name) {
            const token = window.NAGI_TOKEN || '';
            const url = `/api/image?token=${encodeURIComponent(token)}&path=${encodeURIComponent(path)}`;

            imageViewerName.textContent = name;
            imageViewer.src = url;
            imageViewerOverlay.classList.add('visible');
            imageViewerContainer.classList.remove('fullscreen');
        }

        // Close image viewer
        function closeImageViewer() {
            imageViewer.src = '';
            imageViewerOverlay.classList.remove('visible');
            imageViewerContainer.classList.remove('fullscreen');
        }

        // Toggle fullscreen for video
        function toggleVideoFullscreen() {
            if (videoPlayerOverlay.requestFullscreen) {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    videoPlayerOverlay.requestFullscreen();
                }
            } else {
                videoPlayerContainer.classList.toggle('fullscreen');
            }
        }

        // Toggle fullscreen for image
        function toggleImageFullscreen() {
            if (imageViewerOverlay.requestFullscreen) {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    imageViewerOverlay.requestFullscreen();
                }
            } else {
                imageViewerContainer.classList.toggle('fullscreen');
            }
        }

        // Event listeners for file browser
        filerToggleBtn.addEventListener('click', () => {
            filerPanel.classList.add('visible');
            document.getElementById('app').classList.add('filer-open');
            if (!currentFilerPath) {
                loadFiles();
            }
            setTimeout(fitTerminal, 300);
        });

        filerCloseBtn.addEventListener('click', () => {
            filerPanel.classList.remove('visible');
            document.getElementById('app').classList.remove('filer-open');
            setTimeout(fitTerminal, 300);
        });

        filerBackBtn.addEventListener('click', () => {
            if (currentFilerPath) {
                const parts = currentFilerPath.split('/');
                parts.pop();
                const parent = parts.join('/') || '/';
                loadFiles(parent);
            }
        });

        filerRefreshBtn.addEventListener('click', () => {
            loadFiles(currentFilerPath);
        });

        showHiddenFiles.addEventListener('change', () => {
            loadFiles(currentFilerPath);
        });

        // File viewer close
        fileViewerCloseBtn.addEventListener('click', () => {
            fileViewerOverlay.classList.remove('visible');
        });

        fileViewerOverlay.addEventListener('click', (e) => {
            if (e.target === fileViewerOverlay) {
                fileViewerOverlay.classList.remove('visible');
            }
        });

        // Video player close
        videoPlayerCloseBtn.addEventListener('click', closeVideoPlayer);
        videoFullscreenBtn.addEventListener('click', toggleVideoFullscreen);

        videoPlayerOverlay.addEventListener('click', (e) => {
            if (e.target === videoPlayerOverlay || e.target === videoPlayerContainer) {
                closeVideoPlayer();
            }
        });

        // Image viewer close
        imageViewerCloseBtn.addEventListener('click', closeImageViewer);
        imageFullscreenBtn.addEventListener('click', toggleImageFullscreen);

        imageViewerOverlay.addEventListener('click', (e) => {
            if (e.target === imageViewerOverlay || e.target === imageViewerContainer) {
                closeImageViewer();
            }
        });

        // Double click to toggle fullscreen
        imageViewer.addEventListener('dblclick', toggleImageFullscreen);
        videoPlayer.addEventListener('dblclick', toggleVideoFullscreen);

        // ESC key to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (fileViewerOverlay.classList.contains('visible')) {
                    fileViewerOverlay.classList.remove('visible');
                }
                if (videoPlayerOverlay.classList.contains('visible')) {
                    closeVideoPlayer();
                }
                if (imageViewerOverlay.classList.contains('visible')) {
                    closeImageViewer();
                }
                if (filerPanel.classList.contains('visible')) {
                    filerPanel.classList.remove('visible');
                    document.getElementById('app').classList.remove('filer-open');
                    setTimeout(fitTerminal, 300);
                }
            }
        });

        // Close filer panel when clicking outside (on mobile)
        document.addEventListener('click', (e) => {
            if (filerPanel.classList.contains('visible')) {
                if (!filerPanel.contains(e.target) && e.target !== filerToggleBtn) {
                    // Only auto-close on mobile
                    if (window.innerWidth <= 480) {
                        filerPanel.classList.remove('visible');
                        document.getElementById('app').classList.remove('filer-open');
                        setTimeout(fitTerminal, 300);
                    }
                }
            }
        });
    </script>
</body>
</html>
